name: ceilometer
base: core18
version: stein
summary: OpenStack Data Collection Service (ceilometer)
description: |
  collected data to various targets including data stores and message queues.
confinement: classic
grade: devel

apps:
  api:
    command: snap-openstack ceilometer-api
    daemon: simple
    plugs:
      - network
      - network-bind
  collector:
    command: snap-openstack ceilometer-collector
    daemon: simple
    plugs:
      - network
      - network-bind
  agent-notification:
    command: snap-openstack ceilometer-agent-notification
    daemon: simple
    plugs:
      - network
  agent-central:
    command: snap-openstack ceilometer-polling --polling-namespaces central
    daemon: simple
    plugs:
      - network
      - network-bind

parts:
  ceilometer-aodh-gnocchi:
    plugin: python
    python-version: python3
    python-packages:
      - pymysql
      - python-memcached
      - oslo.rootwrap
      - uwsgi
      - git+https://opendev.org/x/snap.openstack#egg=snap.openstack
      - http://tarballs.openstack.org/ceilometer/ceilometer-stable-stein.tar.gz
      - git+https://github.com/gnocchixyz/gnocchi.git@4.3.2
      - http://tarballs.openstack.org/aodh/aodh-stable-stein.tar.gz
    # FIXME: absolute path is used
    constraints:
      - /root/project/upper-constraints.txt
    stage-packages:
      - python3-dev
    build-packages:
      - libffi-dev
      - libssl-dev
      - libxml2-dev
      - libxslt1-dev
      - pkg-config
      - gcc
    #install: |
    #  $SNAPCRAFT_PART_INSTALL/bin/oslo-config-generator --config-file etc/ceilometer/ceilometer-config-generator.conf
    #  mv etc/ceilometer/ceilometer.conf $SNAPCRAFT_PART_INSTALL/etc/ceilometer/ceilometer.conf
  templates:
    after:
      - ceilometer-aodh-gnocchi
    plugin: dump
    source: snap
